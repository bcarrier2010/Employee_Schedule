<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="ES_Style.css">
<script type="text/javascript">
// var colorAaron = "#cb0000";
// var colorJoe = "#986536";
// var colorJonah = "#036400";
 var colorJamie = "#E7E737";

var schedule = new XMLHttpRequest();

function setProperty(colName) {
    var cols = document.querySelectorAll('.' + colName);
    var tm = document.getElementById(colName);
    tm.style["color"] = "#E3CD8D";
    var i;
    for (i = 0; i < cols.length; i++) {
        cols[i].style['textDecoration'] = 'underline';
        cols[i].style["background"] = "#292929";
    }
}

//http://www.sitepoint.com/javascript-generate-lighter-darker-color/
function ColorLuminance(hex, lum) {
    // validate hex string
    hex = String(hex).replace(/[^0-9a-f]/gi, '');
    if (hex.length < 6) {
        hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
    }
    lum = lum || 0;
    // convert to decimal and change luminosity
    var rgb = "#", c, i;
    for (i = 0; i < 3; i++) {
        c = parseInt(hex.substr(i*2,2), 16);
        c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
        rgb += ("00"+c).substr(c.length);
    }
    return rgb;
}

var hexDigits = new Array
        ("0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"); 

//Function to convert hex format to a rgb color
function rgb2hex(rgb) {
 rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
 return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
}

function hex(x) {
  return isNaN(x) ? "00" : hexDigits[(x - x % 16) / 16] + hexDigits[x % 16];
}

function setPropertyById(dayId) {
    var element = document.getElementById(dayId);
    var style = window.getComputedStyle(element);
    var bcolor = style.getPropertyValue('background-color');
    element.style['backgroundColor'] = ColorLuminance(rgb2hex(bcolor), -.25);
}

function getTimeName(n){
    var h;
    if(n){
        switch(n) {
            case 10:
            case '10':
                h = 'ten';
            break;
            case 11:
            case '11':
                h = "eleven";
            break;
            case 12:
            case '12':
                h = "twelve";
            break;
            case 13:
            case '13':
                h = "thirteen";
            break;
            case 14:
            case '14':
                h = "fourteen";
            break;
            case 15:
            case '15':
                h = "fifteen";
            break;
            case 16:
            case '16':
                h = "sixteen";
            break;
            default:
                h = undefined;
        }
        return h;
    }
    else{
        return '';
    }
}

function getDayName(m) {
    switch(m) {
        case 1:
            q = "Monday";
        break;
        case 2:
            q = "Tuesday";
        break;
        case 3:
            q = "Wednesday";
        break;
        case 4:
            q = "Thursday";
        break;
        case 5:
            q = "Friday";
        break;
    }
    return q;
}

function getDayNum(m) {
    var q;
    switch(m) {
        case "Monday":
            q = 1;
        break;
        case "Tuesday":
            q = 2;
        break;
        case "Wednesday":
            q = 3;
        break;
        case "Thursday":
            q = 4;
        break;
        case "Friday":
            q = 5;
        break;
        default:
            q = undefined;
    }
    return q;
}

function setByTime() {
    var i;
    var d = new Date();
    var n = 'ten';//getTimeName(d.getHours());
    var m = 'Tuesday'//getDayName(d.getDay());
    var h;
    
    //setProperty(n);
    setPropertyById(m +'.'+n);
}

function getSchedule(){
    schedule.open("get", "schedule.csv", false);
    schedule.send();
}

function makeTable() {
    var tr;
    var td;
    var dividertd;
    var i, j;
    var emptyBool = 1;
    var notEmpty = [];
    var nc = 0;
    var keep = []
    var e = 0;
    var table = document.getElementById('table');

    var csv = schedule.responseText.split('\n');
    for(var f = 0; f<csv.length; f++){
        csv[f] = csv[f].split(',');
    }

    
    for(var r = 1; r<csv.length; r++){
        for(var c = 0; c<csv[0].length; c++){
            if(csv[r][c] != ''){
                notEmpty[c] = 1;
            }
        }
    }
    for (var i = 0; i < notEmpty.length; i++) {
        if(notEmpty[i]){
            nc++;
        }
    }

    var newCSV = new Array(csv.length);
    for (var i = 0; i < csv.length; i++) {
        newCSV[i] = new Array(nc);
    }

    var y = 0;
    for(var c = 0; c<csv[0].length; c++){
        if(notEmpty[c]){
            for(var r = 0; r<csv.length; r++){
                newCSV[r][y] = csv[r][c];
            }
            y++;
        }
    }

    csv = newCSV;

    var days = [0,0,0,0,0,0];
    for(var c = 0; c<csv[0].length; c++){
        days[getDayNum(csv[0][c])]++;         
    }

    
    var divider = 0;
    var dayCount = 1;
    
    for(i = 0; i<csv.length; i++)
    {
        tr = document.createElement('tr');
        tr.setAttribute('class', getTimeName(parseInt(csv[i][0].substring(0,2))));
        for(j = 0; j<csv[0].length; j++)
        {
            
            td = document.createElement('td');
            if(getTimeName(csv[i][j].substring(0,2))){
                td.setAttribute('id', getTimeName(csv[i][j].substring(0,2)));
                td.setAttribute('class', 'time');
                td.innerHTML = csv[i][j].substring(0,2);
            }
            else if(getDayNum(csv[i][j])){
                td.innerHTML = csv[i][j];
                td.setAttribute('id', csv[i][j]);
                td.setAttribute('class', 'day');
                td.setAttribute('colSpan', days[getDayNum(csv[i][j])]);
                j+=days[getDayNum(csv[i][j])]-1;
            }
            else if(csv[i][j]!=''){
                td.setAttribute('class', csv[i][j]);
                td.setAttribute('id', csv[0][j] + '.' + getTimeName(csv[i][0].substring(0,2)));
            }
            else{
                td.setAttribute('class', csv[0][j] + ' ' + getTimeName(csv[i][0].substring(0,2)));
            }

            tr.appendChild(td);
            if(j < csv[0].length-1 && j==divider){
                dividertd = document.createElement('td');
                dividertd.setAttribute('class', 'divider');
                tr.appendChild(dividertd);
                divider+=days[dayCount];
                dayCount++;
            } 
                       
        }
        table.appendChild(tr);

        if(i==0){
           var linetr = document.createElement('tr');
           linetr.setAttribute('class', 'line');
           var linetd = document.createElement('td');
           linetd.setAttribute('colSpan', nc+5);
           linetr.appendChild(linetd);
           table.appendChild(linetr);
        }

        divider = 0;
        dayCount = 1;
    }

}

function startTimer(){
    setByTime();
    var intervalID = window.setInterval(setByTime, 60000);
}

</script>
</head>
<body onload="getSchedule(); makeTable(); startTimer();">

<table id='table' class='table'>

</table>
</body>
</html>
